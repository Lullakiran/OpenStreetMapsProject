<html>
<head>
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

	 
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="http://cdn.jsdelivr.net/highlight.js/8.6/styles/github.min.css">
	<script src="http://cdn.jsdelivr.net/highlight.js/8.6/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>

</head>
<body>


<div class="container">
	<div class='row'>
		<div class="col-md-12">
			<h1>  OpenStreetMap - Data Wrangling with MongoDB </h1>
			<h4>  	Sinan Hanay </h4> 
			<hr/>
			 <h2 align="center"> I. Gathering Statistics</h3> 
			 			<p>  I cleaned the data for Ankara/Turkey. First I gathered the statistics, using xml tree parser.  </p>

		 </div>


		<div class="col-md-8">
 
 <pre><code class="python">def count_tags(root, tag):
    tag_count = 0 
    for i in root.findall(tag):
        tag_count += 1
    return tag_count

counts = {}
for i in ['node', 'way', 'relation' ]:
    counts[i] = count_tags(root, i)
counts['user'] = count_users(root)
print counts 
#{'node': 638467, 'relation': 220, 'user': 500, 'way': 92056} </code>
</pre>
<pre> Mongodb queries on json file confirms these numbers too <code class="python"> 
> db.ankara.distinct("created.user").length
500
> db.ankara.find({"type":"node"}).count()
638467
> db.ankara.find({"type":"way"}).count()
92056 
> db.ankara.find().count()
730523 </code> </pre>
 </div>
	 	<div class="panel-primary col-md-4">
			  <div class="panel-heading"> Data Summary</div>
		 		

			    		<table class="table table-striped">
			    			<tr> <td> City </td><td> Ankara / Turkey </td> </tr>
	     					<tr> <td> # Node </td><td>638467 </td> </tr>
	     					<tr> <td> # Way </td><td> 92056 </td> </tr>
	     					<tr> <td> # Unique User </td><td> 500 </td> </tr>
	     					<tr> <td> # Relation </td><td> 220 </td> </tr>
	     					<tr> <td> # Documents</td><td> 730523 </td> </tr>
	     					<tr> <td> File Size (osm)</td><td>  134,784,285 bytes</td> </tr>
	     					<tr> <td> File Size (json)</td><td> 169,398,230 bytes </td> </tr>
	     					<tr> <td> Data Source </td><td> <a href="https://s3.amazonaws.com/metro-extracts.mapzen.com/ankara_turkey.osm.bz2"> mapzen.com </a></td> </tr>
	     					<tr> <td> Source File </td><td> project.py </a></td> </tr>

	     					
						</table>

			    </ul>
 
		</div>
	</div>
<hr/>
	<div class='row'>
		<div class="col-md-12">
	<h2 align="center"> II. Data Overview </h2>
		<p>  The following problems have been spotted: </p>
	 	
			<dl class="dl-horizontal">
			  <dt> Abbreviations</dt>
			  <dd> Some place names are shorteneds <i>(e.g. 'Cad.', 'Cd', 'Sk.' for 'Caddesi'  and 'Sokak') </i>	</dd>
			  <dt> Capitalization</dt>
			  <dd> Places lack capitalization <i>(e.g. 'cad.' , u'kalekap\u0131s\u0131' , 'ANKARA')</i></dd>
			  <dt> Postcodes</dt>
			  <dd> All post codes should consist of exactly 5 digits, and should start with 06.</dd>
			</dl> 

			<h3>Post Codes </h3>
			First I looked at the most commong postcodes.
			<pre><code> #checking for most common postcodes
> db.ankara.aggregate({"$match":{"address.postcode":{"$exists":1}}} , 
{"$group": {"_id":"$address.postcode", "count":{"$sum":1}}}, 
{"$sort":{"count":-1}} )

{ "_id" : "06800", "count" : 149 }
{ "_id" : "06810", "count" : 14 }
{ "_id" : "06900", "count" : 11 }
{ "_id" : "06700", "count" : 6 }
{ "_id" : "06540", "count" : 5 }
{ "_id" : "06550", "count" : 5 }</pre></code>
<p> I noticed that 06800 is the dominating postcode, and it belongs to <mark>University District</mark>, which contains two important universities: <mark>Bilkent</mark> and <mark>Middle East Technical University</mark>. 
This area is far from the city center, and not necessarily the densest district. This data probably suggests that university students/staff has been more inclined to enter data. </p>
<br/>


Next, I would like to check if all postcodes are in the range (06000,06999). However I noticed that postcodes were saved as a string field in MongoDB.
After converting postcode field to integers, I checked the range of postcodes. All the postcodes fall between the expected range.
<pre><code> > typeof db.ankara.findOne({"address":{"$exists":1}}).address.postcode
string
#the following line is from http://stackoverflow.com/questions/4973095/mongodb-how-to-change-the-type-of-a-field
> db.ankara.find({"address.postcode" : {$exists : true}}).forEach( 
function(obj) { obj.address.postcode = new NumberInt( obj.address.postcode ); 
db.ankara.save(obj); } );
> typeof db.ankara.findOne({"address":{"$exists":1}}).address.postcode
number
> db.ankara.find({ "$or": [ { "address.postcode" : { "$lt":06000} },  
			    { "address.postcode" : { "$gt":06999} } 
			  ]})
>  </pre></code>


<h3>Most Active Users </h3> Next I looked at who were the most active users.
<pre><code> > db.ankara.aggregate({"$group" :{"_id":"$created.user", "count":{"$sum":1}}}, 
{"$sort":{"count":-1}})
{ "_id" : "penom", "count" : 190775 }
{ "_id" : "katpatuka", "count" : 136518 }
{ "_id" : "summerson", "count" : 128541 }
{ "_id" : "VinothS", "count" : 28441 }
{ "_id" : "nesim", "count" : 19158 }
{ "_id" : "vignesh anand", "count" : 14187 }
{ "_id" : "SathyaV", "count" : 14114 }</pre></code>
<p> From these usernames only Nesim is a Turkish name. Vinoth, Vignesh, Summerson and Sathya are definetely not Turkish. Penom and katpatuka maybe nicknames, or non-Turkish names.


<h3>Ways with Highest Number of Nodes </h3>
Next I looked at the place types that has the most nodes. 
<pre><code> > heavy_roads = db.ankara.aggregate( {"$unwind" : "$node_refs"} , 
		 { "$group" : {"_id" : "$_id", "node_ref_count": { "$sum" :1}}}, 
		 { "$sort" : {"node_ref_count":-1}}, {"$limit":4}) 

{ "_id" : ObjectId("5579c58e3ed2011936d9325c"), "node_ref_count" : 465 }
{ "_id" : ObjectId("5579c58e3ed2011936d9325d"), "node_ref_count" : 465 }
{ "_id" : ObjectId("5579c58c3ed2011936d8a385"), "node_ref_count" : 326 }
{ "_id" : ObjectId("5579c58e3ed2011936d965f7"), "node_ref_count" : 316 }

> db.ankara.find({ "_id" : ObjectId("5579c58e3ed2011936d9325c")},{"node_refs":0, "_id":0,"created":0, "visible":0, "type":0, "id":0})
{ "leisure" : "park" }

> db.ankara.find({ "_id" : ObjectId("5579c58e3ed2011936d9325d")},{"node_refs":0, "_id":0,"created":0, "visible":0, "type":0, "id":0})
 { "barrier" : "hedge" }

> db.ankara.find({ "_id" : ObjectId("5579c58c3ed2011936d8a385")},{"node_refs":0, "_id":0,"created":0, "visible":0, "type":0, "id":0})
{ "highway" : "service" }

> db.ankara.find({ "_id" : ObjectId("5579c58e3ed2011936d965f7")},{"node_refs":0, "_id":0,"created":0, "visible":0, "type":0, "id":0})
{ "waterway" : "stream" }
I tried to look at the places from coordinates, the first one is a sports complex, and the highway and stream makes sense to be there.
</pre></code>

<h3>The Most Common Amenities</h3>
The most common amenities, I think parking is surprising. I would not have expected so many parking places in Ankara. Though, that is probably because 
the mapped dataset is small portion of the whole city.
<pre><code> > db.ankara.aggregate({"$match":{"amenity":{"$exists":1}}}, {"$group":{"_id":"$amenity", "count":{"$sum":1}}}, 
			{"$sort":{"count":-1}}, {"$limit":5})
{ "_id" : "place_of_worship", "count" : 823 }
{ "_id" : "parking", "count" : 512 }
{ "_id" : "school", "count" : 289 }
{ "_id" : "restaurant", "count" : 219 }
{ "_id" : "fuel", "count" : 210 }
</pre></code>

<h3>The Most Popular Streets</h3>
This is the most surprising result, as I never heard any of the following. I also checked Internet and looks like they are not significant.
In the conclusion section, I explain why such a situation happens.
<pre><code> > db.ankara.aggregate({"$match":{"address.street":{"$exists":1}}}, {"$group": {"_id":"$address.street", "count" : {"$sum":1}}}, {"$sort":{"count":-1}}, {"$limit":5} )
{ "_id" : "Tutumlu Sokak", "count" : 18 }
{ "_id" : "Ä°bni Sina Caddesi", "count" : 16 }
{ "_id" : "Ulubey Sokak", "count" : 15 }
{ "_id" : "Yavuzevler Sokak", "count" : 15 }
{ "_id" : "1598. Caddesi", "count" : 11 }

</pre></code>


		</div>
	</div>

 


<div class='row'>
		<div class="col-md-12">
	<h2 align="center"> III. Conclusion </h2>

	When I looked at this data, one thing about street names surprised me.  
	I would like to present briefly some background information before explaining what surprised me.
	Different countries have different addressing schemes.
	  
    I just looked up top restaurants from Yelp ( I removed district names from both)
     
    <ul> 
    	<li>	1723 N Halsted St., Chicago </li> 
    	<li>   Istiklal Street. Emir Nevruz Road. 2/E, Beyoglu (district),  Istanbul</li> 
    	<li>   Jingumae 4-15-3, Shibuya(district), Tokyo </li>
    </ul>

		<p>For example, in USA, it is succint to describe an address by street (N Halsted) and number (1723).
		In Turkey, there are streets and roads. Streets are long  and well known, roads are short and unremarkable. 
		Thus, the address of a point is described by both street and road names most of the time. Because describing 
		just by either one of them will have make them harder to find.</p>

		<p>Thus, in data I was expecting in street field to have both road and street, but only a few entries have it.
		I guess it is either because mostly foreigners entered it, or people who entered could not decide what to do.
		As a result, in the "Most Popular Streets" query, I found some small roads (sokaks), nobody knows. 
		For example, I would surprise if somebody just uses Tutumlu Road and Ulubey Road alone, but both are just next to well known Baglar Street.
		Thus, it would be probably more accurate if also the closest street  name were included (i.e. Baglar Street, Ulubey Road).
		I heard that after foursquare started using OpenStreetMap, people started to complain about the new map, and I can understand why now.</p>

		<p> The situation gets more interesting for Japan, where there are no streets. The address given tells that in Jingumae-4 region, look for block id 15 and building number 3.
		So for Japan, how should be the street fields populated? Because 4-15-3 and 4-15-4 can be on same street, but 4-15-5 can be on another street.</p>

		<p> The reason for discrepancies is because of the city plans. An optimized addressing city plan depends on the plan itself. In a grid-like American city, it is better to
		use street and number system, where in Istanbul each street have lots of connecting roads. In Japan, there are roads as short as tens of meters. </p>

		<p> I think solving this discrepancy can be an interesting challenge, and would surely improve OSM </p>.

</div>
</div>




 


</body>
</html>